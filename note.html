<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CFC Manager Ultimate v4 - AutoSave</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            
            --success-bg: #dcfce7; --success-text: #166534;
            --danger-bg: #fee2e2; --danger-text: #991b1b;
            --warning-bg: #fef9c3; --warning-text: #854d0e;

            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }

        body { background-color: var(--bg-body); color: var(--text-main); padding-bottom: 60px; }

        /* --- TOAST NOTIFICATION (Auto Save) --- */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #334155;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast i { color: #4ade80; }

        /* --- INFO BAR --- */
        .info-bar { display: flex; justify-content: center; gap: 15px; padding: 20px 20px 0 20px; flex-wrap: wrap; }
        .info-pill {
            background-color: #e2e8f0; color: #334155; padding: 8px 20px; border-radius: 50px;
            font-family: 'JetBrains Mono', monospace; font-weight: 500; font-size: 0.95rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; min-width: 120px;
        }
        .timer-pill { min-width: 200px; }

        /* --- HEADER --- */
        header {
            background: var(--bg-card); padding: 15px 30px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; margin-top: 20px;
            position: sticky; top: 0; z-index: 50; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .logo { font-weight: 800; font-size: 1.2rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        .semester-controls { display: flex; align-items: center; gap: 10px; background: #f8fafc; padding: 5px; border-radius: 8px; border: 1px solid var(--border); }
        .semester-select { border: none; background: transparent; font-weight: 600; font-size: 0.9rem; outline: none; padding: 5px; cursor: pointer; color: var(--text-main); }
        .btn-mini { width: 25px; height: 25px; border-radius: 4px; border: 1px solid var(--border); background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-muted); transition: 0.2s; }
        .btn-mini:hover { color: var(--primary); border-color: var(--primary); background: #eff6ff; }

        .main-actions { display: flex; gap: 10px; }
        .btn-action {
            padding: 8px 15px; border-radius: 6px; border: none; font-size: 0.85rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: 0.2s;
        }
        .btn-save { background: var(--text-main); color: white; }
        .btn-save:hover { background: #334155; }
        .btn-settings { background: white; border: 1px solid var(--border); color: var(--text-main); font-size: 1.1rem; padding: 8px 12px; }
        .btn-settings:hover { border-color: var(--primary); color: var(--primary); }
        .btn-reset { background: #fee2e2; color: #991b1b; }
        .btn-reset:hover { background: #fecaca; }

        /* --- LAYOUT --- */
        .container {
            max-width: 1100px; margin: 30px auto; padding: 0 20px;
            display: grid; grid-template-columns: repeat(12, 1fr); gap: 20px;
        }

        .card {
            background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; display: flex; flex-direction: column;
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .card-title { font-weight: 700; font-size: 1rem; }
        .badge { background: #eff6ff; color: var(--primary); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }

        .col-12 { grid-column: span 12; }
        .col-8 { grid-column: span 8; }
        .col-4 { grid-column: span 4; }
        .col-6 { grid-column: span 6; }
        @media (max-width: 900px) { .col-8, .col-4, .col-6 { grid-column: span 12; } }

        /* --- RESULTS --- */
        .results-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        @media (max-width: 600px) { .results-row { grid-template-columns: 1fr; } }
        .result-box { background: white; border: 1px solid var(--border); border-radius: 10px; padding: 15px; text-align: center; }
        .result-box.highlight { background: var(--primary); color: white; border: none; }
        .result-val { font-size: 2rem; font-weight: 800; line-height: 1.2; }
        .result-lbl { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8; margin-bottom: 5px; }
        
        /* --- INPUTS --- */
        .input-std { width: 60px; padding: 6px; text-align: center; border: 1px solid var(--border); border-radius: 6px; font-weight: 500; outline: none; background: white; }
        .input-std:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37,99,235,0.1); }
        .gen-row { display: flex; align-items: center; margin-bottom: 10px; padding: 5px; border-radius: 6px; transition: 0.2s; }
        .gen-row:hover { background: #f8fafc; }
        .gen-label { width: 100px; font-weight: 600; font-size: 0.9rem; flex-shrink: 0; }
        .gen-inputs { display: flex; gap: 8px; overflow-x: auto; flex-grow: 1; padding-bottom: 5px; }
        .gen-avg { width: 50px; text-align: center; font-weight: 800; font-size: 1.1rem; margin-left: 10px; }

        /* --- MODULES --- */
        .mod-list { display: flex; flex-direction: column; gap: 8px; }
        .mod-item { display: flex; align-items: center; gap: 8px; background: #f8fafc; padding: 8px; border-radius: 8px; border: 1px solid transparent; flex-wrap: wrap; }
        .mod-item:focus-within { background: white; border-color: var(--primary); }
        .toggle-apa { cursor: pointer; width: 40px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-weight: 800; font-size: 0.8rem; user-select: none; border: 1px solid transparent; text-transform: uppercase; transition: 0.2s; }
        .is-a { background: var(--success-bg); color: var(--success-text); border-color: #86efac; }
        .is-pa { background: var(--danger-bg); color: var(--danger-text); border-color: #fca5a5; }
        .btn-add { width: 100%; margin-top: 10px; padding: 10px; background: #f8fafc; border: 1px dashed var(--border); border-radius: 8px; color: var(--text-muted); cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: 0.2s; }
        .btn-add:hover { border-color: var(--primary); color: var(--primary); background: #eff6ff; }
        .btn-del { border: none; background: none; color: #cbd5e1; cursor: pointer; margin-left: auto; font-size: 1rem; }
        .btn-del:hover { color: #ef4444; }
        .btn-manage { background: white; border: 1px solid var(--border); padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; color: var(--text-main); font-weight: 500; }
        .btn-manage:hover { border-color: var(--primary); color: var(--primary); }

        /* --- COLORS --- */
        .c-good { color: #16a34a; font-weight: 800; } .c-avg { color: #ca8a04; font-weight: 800; } .c-bad { color: #dc2626; font-weight: 800; }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal { background: white; width: 90%; max-width: 500px; border-radius: 12px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .modal h2 { margin-bottom: 20px; font-size: 1.2rem; }
        .sub-grade-list { margin-bottom: 20px; max-height: 300px; overflow-y: auto; }
        .sub-grade-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        
        .schedule-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--bg-body); }
        .schedule-row label { font-weight: 600; color: var(--text-muted); }
        .schedule-row input { padding: 5px 10px; border: 1px solid var(--border); border-radius: 6px; }

        /* --- ATTENDANCE --- */
        .att-container { display: flex; align-items: center; justify-content: space-around; }
        .circular-chart { max-width: 120px; max-height: 120px; }
        .circle-bg { fill: none; stroke: #eee; stroke-width: 3.8; }
        .circle { fill: none; stroke-width: 2.8; stroke-linecap: round; transition: stroke-dasharray 0.5s ease; }
        .percentage { fill: #334155; font-family: 'Inter', sans-serif; font-weight: 800; font-size: 8px; text-anchor: middle; dominant-baseline: central; }
        .att-stats { font-size: 0.85rem; display: flex; flex-direction: column; gap: 5px; }
        .val-a { color: var(--success-text); font-weight: 700; } .val-pa { color: var(--danger-text); font-weight: 700; }
         .sidebar {
      width: 220px;
      background: #ffffff;
      padding: 20px;
      box-shadow: 2px 0 10px rgba(0,0,0,0.05);
    }
    .sidebar h4 {
      margin: 20px 0 10px;
      font-size: 14px;
      text-transform: uppercase;
      color: #555;
    }
    .sidebar a {
      display: block;
      text-decoration: none;
      color: #333;
      margin: 6px 0;
      font-size: 14px;
    }
main {
  display: grid;
  grid-template-columns: 220px 1fr; /* Sidebar fixed, content flexible */
  gap: 20px; /* optional spacing between sidebar and content */
}

@media (max-width: 900px) {
  main {
    grid-template-columns: 1fr; /* Stack sidebar and content on small screens */
  }
}

    </style>
</head>
<body>

<div id="saveToast" class="toast">
    <i class="fa-solid fa-circle-check"></i> Sauvegarde auto...
</div>

<div class="info-bar">
    <div class="info-pill" id="liveTime">--:--:--</div>
    <div class="info-pill" id="liveDate">--.--.----</div>
    <div class="info-pill timer-pill" id="liveTimer">Calcul...</div>
</div>

<header>
    <div class="logo"><i class="fa-solid fa-shapes"></i> Gestion Etudes v4</div>
    
    <div class="semester-controls">
        <select id="semesterSelect" class="semester-select" onchange="switchSemester()"></select>
        <button class="btn-mini" onclick="addSemester()" title="Ajouter"><i class="fa-solid fa-plus"></i></button>
        <button class="btn-mini" onclick="deleteSemester()" title="Supprimer"><i class="fa-solid fa-minus"></i></button>
    </div>

    <div class="main-actions">
        <button class="btn-action btn-settings" onclick="openScheduleSettings()" title="Horaires">
            <i class="fa-solid fa-clock"></i>
        </button>
        <button class="btn-action btn-save" onclick="downloadJSON()">
            <i class="fa-solid fa-download"></i> JSON
        </button>
        <button class="btn-action btn-import" onclick="document.getElementById('fileInput').click()">
            <i class="fa-solid fa-upload"></i>
        </button>
        <button class="btn-action btn-reset" onclick="resetAllData()">
            <i class="fa-solid fa-trash"></i>
        </button>
        <input type="file" id="fileInput" hidden onchange="importJSON(this)">
    </div>
</header>
<main>
 <aside class="sidebar">
    <h4>Liens</h4>
    <a href="modeles.html" class="nav-item">modèles</a>
            <a href="liens.html" class="nav-item">liens utiles</a>
            <a href="resume.html" class="nav-item">resume</a>
  </aside>

<div class="container">

    <div class="col-12 results-row">
        <div class="result-box">
            <div class="result-lbl">Base (Math/Ang)</div>
            <div class="result-val" id="dispBase">--</div>
        </div>
        <div class="result-box">
            <div class="result-lbl">Info (Mod/CIE)</div>
            <div class="result-val" id="dispInfo">--</div>
        </div>
        <div class="result-box highlight">
            <div class="result-lbl">Moyenne Globale</div>
            <div class="result-val" id="dispGlobal">--</div>
        </div>
    </div>

    <div class="col-8 card">
        <div class="card-header">
            <div class="card-title">Branches Générales</div>
            <div>
                <button class="btn-mini" onclick="addCol()" title="Ajouter note" style="width:30px">+</button>
                <button class="btn-mini" onclick="remCol()" title="Enlever note" style="width:30px">-</button>
            </div>
            <div style="margin-top:5px">
    <button class="btn-mini" onclick="addSubject()" title="Ajouter matière" style="width:70px"><i class="fa-solid fa-plus"></i> Matière</button>
    <button class="btn-mini" onclick="remSubject()" title="Supprimer matière" style="width:70px"><i class="fa-solid fa-minus"></i> Matière</button>
</div>

        </div>
        <div id="genContainer"></div>
    </div>

    <div class="col-4 card">
        <div class="card-header">
            <div class="card-title">Suivi Périodes</div>
            <span class="badge">Auto</span>
        </div>
        <div class="att-container">
            <svg viewBox="0 0 36 36" class="circular-chart">
                <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                <path class="circle" id="attCircle" stroke="#2563eb" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                <text x="18" y="18" class="percentage" id="attText">0%</text>
            </svg>
            <div class="att-stats">
                <div class="stat-row"><span>Total:</span> <span id="attTotal">0</span></div>
                <div class="stat-row"><span>A:</span> <span id="attSuivi" class="val-a">0</span></div>
                <div class="stat-row"><span>PA:</span> <span id="attPerdu" class="val-pa">0</span></div>
            </div>
        </div>
    </div>

    <div class="col-6 card">
        <div class="card-header">
            <div class="card-title">Modules</div>
            <span class="badge">Coeff 0.8</span>
        </div>
        <div class="mod-list" id="modList"></div>
        <button class="btn-add" onclick="addItem('modules')">+ Ajouter Module</button>
        <div style="text-align:right; margin-top:10px; font-weight:700; font-size:0.9rem;">
            Moy. 0.5: <span id="avgMod">--</span>
        </div>
    </div>

    <div class="col-6 card">
        <div class="card-header">
            <div class="card-title">CIE</div>
            <span class="badge">Coeff 0.2</span>
        </div>
        <div class="mod-list" id="cieList"></div>
        <button class="btn-add" onclick="addItem('cie')">+ Ajouter CIE</button>
        <div style="text-align:right; margin-top:10px; font-weight:700; font-size:0.9rem;">
            Moy. 0.5: <span id="avgCie">--</span>
        </div>
    </div>

</div>

<div class="modal-overlay" id="gradeModal">
    <div class="modal">
        <h2 id="modalTitle">Gestion Notes</h2>
        <div class="sub-grade-list" id="modalSubGrades"></div>
        <button class="btn-add" onclick="addSubGrade()" style="margin-bottom:20px">+ Note pondérée</button>
        <div class="modal-actions">
            <button class="btn-action btn-import" onclick="closeModal('gradeModal')">Annuler</button>
            <button class="btn-action btn-save" onclick="saveModal()">Enregistrer</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="scheduleModal">
    <div class="modal">
        <h2><i class="fa-solid fa-clock"></i> Fin des cours</h2>
        <p style="margin-bottom: 20px; color:#64748b; font-size:0.9rem;">Définissez l'heure de fin pour chaque jour.</p>
        
        <div id="scheduleInputs">
            </div>

        <div class="modal-actions" style="margin-top:20px;">
            <button class="btn-action btn-import" onclick="closeModal('scheduleModal')">Annuler</button>
            <button class="btn-action btn-save" onclick="saveScheduleSettings()">Enregistrer</button>
        </div>
    </div>
</div>
</main>
<script>
    // --- DATA ---
    let appData = {
        currentId: 1,
        // Configuration des horaires par défaut (1=Lun, 5=Ven)
        weekSchedule: {
            1: "17:25", 2: "17:25", 3: "17:25", 4: "17:25", 5: "17:25"
        },
        semesters: [
            {
                id: 1, name: "Semestre 1",
                general: { ecg: [null, null, null], math: [null, null, null], ang: [null, null, null] },
                modules: [ { id: "I320", name: "Progra", note: 4.5, periods: 32, status: 'a', subGrades: [{val:4.5, weight:100}] } ],
                cie: [ { id: "C106", name: "DB", note: 5, periods: 24, status: 'a', subGrades: [{val:5, weight:100}] } ]
            }
        ]
    };

    // --- TIME & DATE ENGINE ---
    function updateTime() {
        const now = new Date();
        
        // 1. Display
        document.getElementById('liveTime').textContent = now.toLocaleTimeString('fr-FR');
        document.getElementById('liveDate').textContent = now.toLocaleDateString('fr-CH');

        // 2. Logic
        const day = now.getDay();
        const curMin = now.getHours() * 60 + now.getMinutes();
        const curSec = now.getSeconds();

        // Weekend Check
        if(day === 0 || day === 6) {
            document.getElementById('liveTimer').textContent = "Bon Week-end !";
            return;
        }

        // Récupérer l'heure de fin configurée pour aujourd'hui
        const endTimeStr = appData.weekSchedule[day] || "17:25";
        const [endH, endM] = endTimeStr.split(':').map(Number);
        const endMinutes = endH * 60 + endM;

        // Pauses fixes (Matin, Midi, Après-midi) + Fin Variable
        const events = [
            { t: 575, name: "Pause (Matin)", type: "next" },    // 09:35
            { t: 590, name: "EN PAUSE", type: "now" },          // 09:50
            { t: 735, name: "Pause Midi", type: "next" },       // 12:15
            { t: 790, name: "PAUSE MIDI", type: "now" },        // 13:10
            { t: 885, name: "Pause (Ap-midi)", type: "next" },  // 14:45
            { t: 900, name: "EN PAUSE", type: "now" },          // 15:00
            { t: endMinutes, name: "Fin des Cours", type: "next" } // Variable
        ];

        // Trier au cas où l'utilisateur met une fin avant 15h
        events.sort((a,b) => a.t - b.t);

        let activeEvent = null;
        for (let ev of events) {
            if (curMin < ev.t) {
                activeEvent = ev;
                break;
            }
        }

        const timerDiv = document.getElementById('liveTimer');
        if (!activeEvent) {
            timerDiv.textContent = "Cours terminés";
        } else if (activeEvent.type === "now") {
            timerDiv.textContent = activeEvent.name;
        } else {
            const totalSec = (activeEvent.t * 60) - (curMin * 60 + curSec);
            const h = Math.floor(totalSec / 3600);
            const m = Math.floor((totalSec % 3600) / 60);
            const s = totalSec % 60;
            timerDiv.textContent = `${activeEvent.name}: ${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }
    }
    setInterval(updateTime, 1000);

    // --- SCHEDULE SETTINGS ---
    function openScheduleSettings() {
        const div = document.getElementById('scheduleInputs');
        div.innerHTML = '';
        const days = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi"];
        
        days.forEach((d, idx) => {
            const dayNum = idx + 1; // 1 to 5
            const val = appData.weekSchedule[dayNum] || "17:25";
            div.innerHTML += `
                <div class="schedule-row">
                    <label>${d}</label>
                    <input type="time" id="sched_day_${dayNum}" value="${val}">
                </div>
            `;
        });
        document.getElementById('scheduleModal').style.display = 'flex';
    }

    function saveScheduleSettings() {
        for(let i=1; i<=5; i++) {
            const el = document.getElementById(`sched_day_${i}`);
            if(el) appData.weekSchedule[i] = el.value;
        }
        saveAndRender();
        closeModal('scheduleModal');
        updateTime(); // Refresh timer immediately
    }

    // --- MODAL NOTES ---
    let tempSubGrades = [];
    let currentModalType = null;
    let currentModalIndex = null;

    function openModal(type, index) {
        currentModalType = type; currentModalIndex = index;
        const s = getCurSem(); const item = s[type][index];
        document.getElementById('modalTitle').innerText = `${item.id} - ${item.name}`;
        tempSubGrades = JSON.parse(JSON.stringify(item.subGrades || []));
        renderModalGrades();
        document.getElementById('gradeModal').style.display = 'flex';
    }
function addSubject() {
    const s = getCurSem();
    const name = prompt("Nom de la nouvelle matière ?");
    if (!name) return;
    if (s.general[name]) return alert("Cette matière existe déjà !");
    s.general[name] = [null]; // just an array of marks
    saveAndRender();
}


function remSubject() {
    const s = getCurSem();
    const keys = Object.keys(s.general);
    if (keys.length <= 1) return alert("Impossible de supprimer la dernière matière");
    const name = prompt("Nom de la matière à supprimer ?\n" + keys.join(", "));
    if (!name || !s.general[name]) return alert("Matière introuvable");
    delete s.general[name];
    saveAndRender();
}


    function renderModalGrades() {
        const div = document.getElementById('modalSubGrades'); div.innerHTML = '';
        tempSubGrades.forEach((g, i) => {
            div.innerHTML += `<div class="sub-grade-row"><input type="number" step="0.1" class="input-std" placeholder="Note" value="${g.val}" onchange="updateTempGrade(${i},'val',this.value)"><div style="font-size:0.8rem">Poids (%):</div><input type="number" class="input-std" placeholder="%" value="${g.weight}" onchange="updateTempGrade(${i},'weight',this.value)"><button class="btn-del" onclick="removeTempGrade(${i})"><i class="fa-solid fa-trash"></i></button></div>`;
        });
        if(tempSubGrades.length===0) div.innerHTML='<div style="text-align:center;color:#999;">Aucune note</div>';
    }
    function addSubGrade() { tempSubGrades.push({val:'', weight:100}); renderModalGrades(); }
    function updateTempGrade(i,f,v) { tempSubGrades[i][f]=v; }
    function removeTempGrade(i) { tempSubGrades.splice(i,1); renderModalGrades(); }
    
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    
    function saveModal() {
        const s = getCurSem();
        s[currentModalType][currentModalIndex].subGrades = tempSubGrades.filter(g => g.val !== '' && g.weight !== '');
        saveAndRender(); closeModal('gradeModal');
    }

    // --- CORE LOGIC (Notes, Colors, Helpers) ---
    const round01=n=>(n||n===0)?Math.round(n*10)/10:null;
    const round05=n=>(n||n===0)?Math.round(n*2)/2:null;
    const getAvg=a=>{const v=a.filter(x=>x!==null&&x!==""&&!isNaN(x)).map(Number);return v.length?v.reduce((x,y)=>x+y,0)/v.length:null;};
    const getColor=n=>{if(!n&&n!==0)return'';if(n<4)return'c-bad';if(n<5)return'c-avg';return'c-good';};

    function render() {
        const sem = getCurSem(); if(!sem) return;
        
        // 1. General
      const gc = document.getElementById('genContainer');
gc.innerHTML = '';

Object.keys(sem.general).forEach(subject => {
    const marks = sem.general[subject];
    const avg = round05(getAvg(marks));

    const inputs = marks.map((v, i) => 
        `<input type="number" step="0.1" class="input-std" value="${v === null ? '' : v}" onchange="updGen('${subject}', ${i}, this.value)">`
    ).join('');

    gc.innerHTML += `
        <div class="gen-row">
            <div class="gen-label">${subject}</div>
            <div class="gen-inputs">${inputs}</div>
            <div class="gen-avg ${getColor(avg)}">${avg !== null ? avg.toFixed(1) : '-'}</div>
        </div>
    `;
});





        // 2. Modules & CIE
        renderList('modules', sem.modules, 'modList', 'avgMod');
        renderList('cie', sem.cie, 'cieList', 'avgCie');
        
        // 3. Select
        document.getElementById('semesterSelect').innerHTML = appData.semesters.map(s=>`<option value="${s.id}" ${s.id==appData.currentId?'selected':''}>${s.name}</option>`).join('');
        
        // 4. Calc
        calcAll(sem);
    }

    function renderList(t,l,id,aid) {
        const c=document.getElementById(id); c.innerHTML=''; let s=0,cn=0;
        l.forEach((it,ix)=>{
            if(!it.subGrades) it.subGrades = it.note ? [{val:it.note, weight:100}] : [];
            let wAvg = null, totV=0, totW=0;
            it.subGrades.forEach(g=>{ const v=parseFloat(g.val),w=parseFloat(g.weight); if(!isNaN(v)&&!isNaN(w)){totV+=v*w; totW+=w;} });
            if(totW>0) wAvg = Math.round((totV/totW)*10)/10;
            it.note = wAvg;

            if(wAvg!==null){s+=parseFloat(wAvg);cn++;}
            const cls = it.status==='a'?'is-a':'is-pa'; const txt = it.status==='a'?'A':'PA';
            c.innerHTML+=`<div class="mod-item"><input type="text" class="input-std" style="width:50px;text-align:left" value="${it.id}" onchange="updItem('${t}',${ix},'id',this.value)"><input type="text" class="input-std" style="flex:1;text-align:left;min-width:80px" value="${it.name}" onchange="updItem('${t}',${ix},'name',this.value)"><div style="font-size:0.7rem;color:#64748b">Pér:</div><input type="number" class="input-std" style="width:45px" value="${it.periods||''}" onchange="updItem('${t}',${ix},'periods',this.value)"><div class="toggle-apa ${cls}" onclick="togStatus('${t}',${ix})">${txt}</div><button class="btn-manage ${getColor(wAvg)}" onclick="openModal('${t}',${ix})">${wAvg!==null?wAvg:'Gérer'} <i class="fa-solid fa-pen-to-square"></i></button><button class="btn-del" onclick="delItem('${t}',${ix})"><i class="fa-solid fa-xmark"></i></button></div>`;
        });
        const a = round05(cn?s/cn:null);
        const sp = document.getElementById(aid); sp.innerText=a!==null?a.toFixed(1):'--'; sp.className=getColor(a);
    }

    function calcAll(sem) {
        const m05=round05(getAvg(sem.general.math)), a05=round05(getAvg(sem.general.ang)), e05=round05(getAvg(sem.general.ecg));
        const mo05=round05(getAvg(sem.modules.map(m=>m.note))), ci05=round05(getAvg(sem.cie.map(m=>m.note)));

        let rB=null; if(m05&&a05) rB=round01((m05+a05)/2);
        let rI=null; if(mo05!==null) { const vc=ci05!==null?ci05:mo05; rI=round01((8*mo05+2*vc)/10); }
        let rG=null; if(rI&&e05&&rB) rG=round01((3*rI+2*e05+1*rB)/6);

        updDisp('dispBase',rB); updDisp('dispInfo',rI); updDisp('dispGlobal',rG);

        let tot=0, sui=0;
        [...sem.modules,...sem.cie].forEach(m=>{ const p=parseFloat(m.periods)||0; tot+=p; if(m.status==='a') sui+=p; });
        const per=tot-sui, pct=tot>0?Math.round((sui/tot)*100):0;

        document.getElementById('attTotal').textContent=tot; document.getElementById('attSuivi').textContent=sui; document.getElementById('attPerdu').textContent=per;
        document.getElementById('attText').textContent=pct+'%';
        const c=document.getElementById('attCircle'); c.setAttribute('stroke-dasharray',`${pct},100`); c.setAttribute('stroke',pct>=80?'#10b981':'#ef4444');
    }

    function updDisp(id,v) { const el=document.getElementById(id); el.innerText=v!==null?v.toFixed(1):'--'; el.className=`result-val ${v!==null?getColor(v):''}`; }

    // --- ACTIONS ---
function updGen(subject, index, value) {
    const sem = getCurSem();
    if (!sem.general[subject]) return;
    sem.general[subject][index] = value === '' ? null : parseFloat(value);
    saveAndRender();
}


  function addCol() {
    const sem = getCurSem();
    Object.keys(sem.general).forEach(subj => sem.general[subj].push(null));
    saveAndRender();
}

function remCol() {
    const sem = getCurSem();
    const keys = Object.keys(sem.general);
    // Only remove if there’s more than 1 mark
    const firstKey = keys[0];
    if (sem.general[firstKey].length <= 1) return;
    keys.forEach(subj => sem.general[subj].pop());
    saveAndRender();
}

    function updItem(t,i,f,v) { getCurSem()[t][i][f]=(f==='periods')?(v===""?null:parseFloat(v)):v; saveAndRender(); }
    function togStatus(t,i) { const s=getCurSem(); s[t][i].status=s[t][i].status==='a'?'pa':'a'; saveAndRender(); }
    function addItem(t) { getCurSem()[t].push({id:"",name:"",note:null,periods:0,status:'a',subGrades:[]}); saveAndRender(); }
    function delItem(t,i) { getCurSem()[t].splice(i,1); saveAndRender(); }

    function getCurSem() { return appData.semesters.find(s=>s.id==appData.currentId); }
    function switchSemester() { appData.currentId=document.getElementById('semesterSelect').value; saveAndRender(); }
    function addSemester() { const id=Date.now(), n=appData.semesters.length+1; appData.semesters.push({id:id,name:`Semestre ${n}`,general:{ecg:[null],math:[null],ang:[null]},modules:[],cie:[]}); appData.currentId=id; saveAndRender(); }
    function deleteSemester() { if(appData.semesters.length<=1)return alert("Impossible"); if(confirm("Supprimer ?")) { appData.semesters=appData.semesters.filter(s=>s.id!=appData.currentId); appData.currentId=appData.semesters[0].id; saveAndRender(); } }
    
    // --- LOCAL STORAGE MANAGER ---
    let toastTimeout;
    function showToast() {
        const t = document.getElementById('saveToast');
        t.classList.add('show');
        clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => {
            t.classList.remove('show');
        }, 1500);
    }

    function saveAndRender() {
        // Sauvegarde dans le localStorage
        localStorage.setItem('cfc_ult_v4', JSON.stringify(appData));
        // Mise à jour de l'affichage
        render();
        // Notification visuelle
        showToast();
    }

    function load() {
        const d = localStorage.getItem('cfc_ult_v4'); 
        if(d) { 
            try {
                appData = JSON.parse(d); 
                if(!appData.weekSchedule) appData.weekSchedule={1:"17:25",2:"17:25",3:"17:25",4:"17:25",5:"17:25"}; 
            } catch(e) {
                console.error("Erreur lecture données", e);
            }
        }
        render(); 
        updateTime();
    }

    function resetAllData() { if(confirm("Tout effacer ?")) { localStorage.removeItem('cfc_ult_v4'); location.reload(); } }
    function downloadJSON() { const b=new Blob([JSON.stringify(appData,null,2)],{type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download="notes_cfc.json"; a.click(); }
    function importJSON(inp) { const f=inp.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{try{appData=JSON.parse(e.target.result); saveAndRender(); alert("Import OK");}catch(x){alert("Erreur");}}; r.readAsText(f); inp.value=''; }

    // Init
    load();
</script>
</body>
</html>